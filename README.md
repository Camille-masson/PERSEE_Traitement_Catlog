---
title: "Catalog Processing - README"
author: '[MASSON Camille / Script Ã©crit par : PERRON RÃ©my]'
date: 'DerniÃ¨re mise Ã  jour : [14/02/2025]'
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: readable
    css: styles.css
  pdf_document:
    toc: true
    number_sections: true
    latex_engine: xelatex
    extra_dependencies: ["georgia"]
fontsize: 12pt
mainfont: Georgia
geometry: margin=1in
---

<style>
  body {
    font-family: Georgia, serif;
    text-align: justify;
  }
  h1, h2, h3, h4, h5, h6 {
    font-family: Georgia, serif;
  }
</style>

## PrÃ©sentation

Ce script rÃ©alisÃ© par PERRON RÃ©my durant sa thÃ¨se permet dâ€™extraire et dâ€™analyser les donnÃ©es issues des colliers GPS Catlog afin de caractÃ©riser les dÃ©placements selon trois comportements :

- Repos  
- DÃ©placement  
- PÃ¢turage  

Il permet Ã©galement de calculer les taux de chargement sur les alpages Ã©tudiÃ©s. Il a Ã©tÃ© adaptÃ© pour permettre un partage de cette mÃ©thode aux diffÃ©rents utilisateurs dans le cadre du projet PERSEE.

Lâ€™implÃ©mentation repose sur R et RStudio, avec une gestion collaborative via GitHub.

---

## Installation et Configuration du DÃ©pÃ´t

### PrÃ©requis

Avant de commencer, assurez-vous dâ€™avoir installÃ© le logiciel Git :

- [Git](https://git-scm.com/) | Assurez-vous Ã©galement de l'avoir correctement configurÃ© avec votre IDE (RStudio). Vous pouvez consulter les tutoriels suivants si nÃ©cessaire :  
  - [Tuto_1](https://youtu.be/QLFc9gw_Hfs?si=W2lMnlM_NHd5S7ba)  
  - [Tuto_2](https://youtu.be/bUoN85QvC10?si=O33JTkJ3NFHiF1zp)




### Clonage du DÃ©pÃ´t

Le projet fonctionne sous forme dâ€™un dÃ©pÃ´t GitHub. Pour le cloner localement :

```
# Ã‰tapes dâ€™installation
1. CrÃ©er un compte GitHub (si ce nâ€™est pas dÃ©jÃ  fait)
2. Ouvrir RStudio
3. Aller dans Fichier â†’ Nouveau projet â†’ Version Control â†’ Git
4. Entrer lâ€™URL du dÃ©pÃ´t GitHub et sÃ©lectionner un rÃ©pertoire local pour lâ€™enregistrer :

git clone : https://github.com/Camille-masson/Catlog_processing.git
```

---

## Organisation des Fichiers

Le projet suit une organisation bien structurÃ©e :

```
ğŸ“‚ Catlog_processing/ # RÃ©pertoire principal du projet
â”‚-- ğŸ“‚ Functions/     # Dossier contenant les fonctions utilisÃ©es, partagÃ© via Git
â”‚-- ğŸ“‚ raster/        # Fichiers NDVI nÃ©cessaires aux calculs, format .tif
â”‚-- ğŸ“‚ data/          # DonnÃ©es dâ€™entrÃ©e, avec un exemple de jeu dâ€™entraÃ®nement
â”‚   â”‚-- ğŸ“‚ Colliers_AAAA_brutes/(AAAA = AnnÃ©e dâ€™Ã©tude, 9999 pour le jeu de dÃ©monstration)
â”‚   â”‚   â”‚-- 9999_infos_alpages.csv  (Infos sur les alpages Ã©tudiÃ©s)
â”‚   â”‚   â”‚-- 9999_tailles_troupeaux.csv (Taille des troupeaux au cours de la saison)
â”‚   â”‚   â”‚-- 9999_colliers_poses.csv (DÃ©tails des colliers et paramÃ¨tres)
â”‚   â”‚   â”‚-- ğŸ“‚ Alpage_demo/  (DonnÃ©es GPS des individus Ã©tudiÃ©s)
â”‚   â”‚   â”‚   â”‚-- C00_000000.csv  (Exemple de fichier GPS dâ€™un collier)
â”‚   â”‚   â”‚   â”‚-- C01_000000.csv  (Exemple de fichier GPS dâ€™un collier)
â”‚   â”‚   â”‚   â”‚-- C02_000000.csv  (Exemple de fichier GPS dâ€™un collier)
â”‚-- ğŸ“‚ outputs/       # Dossier oÃ¹ seront enregistrÃ©s les fichiers de sortie
â”‚-- config.R          # Script dÃ©finissant les chemins et le chargement des packages
â”‚-- script_analysis.R # Script principal exÃ©cutant les diffÃ©rentes Ã©tapes de traitement
```

Tous les fichiers seront donc dÃ©jÃ  crÃ©Ã©s lors du partage du projet Git ! Cependant, notamment pour le dossier `data`, il faudra organiser correctement les fichiers en suivant le modÃ¨le explicitÃ© ci-dessus et en sâ€™appuyant sur la structure du jeu de donnÃ©es dâ€™entraÃ®nement fourni. Voir la partie 4 pour plus de dÃ©tails sur la forme et la structure des donnÃ©es. 



---

## Description des donnÃ©es dâ€™entrÃ©e

### Jeu de donnÃ©es de dÃ©monstration
Ce jeu de donnÃ©es est dÃ©jÃ  strcturÃ© et paratgÃ© de maniÃ¨re correcte via le Git. Il s'agit d'un jeu de donnÃ©es dont lâ€™annÃ©e dâ€™Ã©chantillonnage est fictive, fixÃ©e Ã  9999, et dont lâ€™alpage fictif est Ã©tabli sous le nom *Alpage_demo*. Ce jeu de donnÃ©es dâ€™entraÃ®nement prÃ©sente un Ã©chantillon de points GPS de 3 colliers sur une pÃ©riode dâ€™Ã©chantillonnage restreinte Ã  1 mois. Il permet Ã  la fois dâ€™illustrer et de comprendre les diffÃ©rentes tables dâ€™entrÃ©e, mais Ã©galement de faciliter lâ€™interprÃ©tation du script principal.

### DonnÃ©es GPS

Chaque collier GPS extrait via le logiciel Catlog gÃ©nÃ¨re un fichier `.csv` encodÃ© en UTF-8, contenant les colonnes suivantes :

| **Colonne**           | **Description**                                        |
|-----------------------|--------------------------------------------------------|
| Date                 | Date dâ€™enregistrement *(format : `dd/mm/yyyy`)*           |
| Time                 | Heure dâ€™enregistrement *(format : `hh:mm:ss`)*           |
| Latitude             | Latitude GPS                                          |
| Longitude            | Longitude GPS                                         |
| Altitude             | Altitude en mÃ¨tres                                    |
| Satellites           | Nombre de satellites utilisÃ©s                         |
| HDOP                 | PrÃ©cision horizontale du GPS                          |
| PDOP                 | PrÃ©cision tridimensionnelle du GPS                    |
| Temperature [C]      | TempÃ©rature mesurÃ©e en degrÃ©s Celsius                 |
| Speed [km/h]        | Vitesse en km/h                                       |
| TTFF                 | Temps nÃ©cessaire pour le premier signal GPS           |
| SNR AVG              | Rapport signal/bruit moyen des satellites utilisÃ©s    |
| SNR MAX              | Rapport signal/bruit maximum parmi les satellites     |

**Remarque** : Pour les utilisateurs nâ€™ayant pas de colliers Catlog, seules les colonnes Date, Time, Latitude, Longitude sont indispensables.


---

### Tables de MÃ©tadonnÃ©es

#### Informations des alpages Ã©tudiÃ©s : `AAAA_infos_alpages.csv`

Ce tableau regroupe les informations principales liÃ©es Ã  lâ€™alpage. Dans le jeu de donnÃ©es de dÃ©monstration, un seul alpage est dÃ©taillÃ©, mais si dâ€™autres alpages figurent dans votre jeu de donnÃ©es, il suffit dâ€™ajouter de nouvelles lignes en spÃ©cifiant un nom de rÃ©fÃ©rence pour chaque alpage.

| **Variable**              | **Description**                                                    |
|---------------------------|------------------------------------------------------------------|
| alpage                    | Nom de lâ€™alpage Ã©tudiÃ©                                           |
| nom_alpage_determinant    | Nom de l'alpage au format long (pour les visualisations)         |
| date_pose                 | Date de pose des colliers *(format : `dd/mm/yyyy hh:mm:ss`)*     |
| date_retrait              | Date de retrait des colliers *(format : `dd/mm/yyyy hh:mm:ss`)*  |
| proportion_jour_allume    | Fraction de la journÃ©e oÃ¹ les colliers sont allumÃ©s *(1 = 24h/24)* |
| taille_troupeau           | Taille du troupeau associÃ© Ã  lâ€™alpage                            |
| nom1_UP                   | ?Nom de lâ€™unitÃ© de pÃ¢turage principale?                          |
| medcrit                   | Valeur seuil median (en mÃ¨tre) ; *ParmÃ¨tres de Bjorneraas*         |
| meancrit                  | Valeur seuil moyen (en mÃ¨tre) ; *ParmÃ¨tres de Bjorneraas*          |
| spikesp                   | Seuil de vitesse du pic ; *ParmÃ¨tres de Bjorneraas*                |
| spikecos                  | Seuil de l'angle du pic ; *ParmÃ¨tres de Bjorneraas*                |


#### Ã‰volution de la taille du troupeau : `AAAA_tailles_troupeaux.csv`

Ce tableau prÃ©sente lâ€™Ã©volution de la taille du troupeau au cours de la saison dâ€™alpage.

La taille du troupeau peut Ãªtre :

- Fixe (cas le plus frÃ©quent, oÃ¹ elle ne varie pas).
- Variable au cour de la saison, notamment en raison de contraintes techniques ou de mesures de gestion (ex. : alpage du Viso).

Dans ce dernier cas, il est nÃ©cessaire de noter lâ€™Ã©volution de la taille du troupeau pour chaque date de variation, en prÃ©cisant lâ€™alpage concernÃ© ainsi que la nouvelle taille du troupeau Ã  la date donnÃ©e.

| **Variable**              | **Description**                                                    |
|---------------------------|------------------------------------------------------------------|
| alpage                    | Nom de lâ€™alpage Ã©tudiÃ©                                          |
| date_debut_periode        | Date de dÃ©but de la pÃ©riode *(format : `dd/mm/yyyy`)*            |
| taille_totale_troupeau    | Taille totale du troupeau Ã  cette date                          |


#### Informations individuelles sur les colliers et les individus : `AAAA_colliers_poses.csv`

Ce tableau contient les informations relatives aux individus sur lesquels les colliers ont Ã©tÃ© posÃ©s, telles que lâ€™espÃ¨ce, la pÃ©riode dâ€™Ã©chantillonnage, la proportion de jour allumÃ©, ainsi que les dates de pose et de retrait pour chaque individu.

| **Variable**              | **Description**                                                   |
|---------------------------|-----------------------------------------------------------------|
| Collier                   | Identifiant du collier                                               |
| Bat                       | RÃ©fÃ©rence de la batterie du GPS *(optionnel)*                          |
| Programmation             | Type de programmation du collier                                     |
| Alpage                    | Nom de lâ€™alpage oÃ¹ lâ€™individu se trouve                              |
| EspÃ¨ce                    | EspÃ¨ce de lâ€™individu *(optionnel)*                                     |
| Race                      | Race de lâ€™individu *(optionnel)*                                       |
| Ã‰leveur                   | Identifiant de lâ€™Ã©leveur *(optionnel)*                                 |
| Ã‚ge                       | Ã‚ge de lâ€™individu en annÃ©es *(optionnel)*                              |
| PÃ©riode Ã©chantillonnage   | PÃ©riode dâ€™Ã©chantillonnage, durÃ©e en secondes *(temps dâ€™acquisition entre deux points)* |
| Proportion jour allumÃ©    | Fraction de la journÃ©e durant laquelle le collier est allumÃ© *(1 = 24h/24)        |
| Date pose                 | Date de pose du collier *(format : `dd/mm/yyyy hh:mm:ss`)*     |
| Date retrait              | Date de retrait du collier *(format : `dd/mm/yyyy hh:mm:ss`)*  |



## Description du code

### config.R

Le script `config.R` permet de configurer automatiquement lâ€™environnement de travail du projet. Il dÃ©finit :

- Les chemins des dossiers principaux
- Le chargement des bibliothÃ¨ques
- Le chargement automatique des fonctions
- Les paramÃ¨tres globaux

*Remarque* : Il est essentiel dâ€™exÃ©cuter (`source`) ce script pour garantir le bon fonctionnement du projet. Ce script est automatiquement appelÃ© dans `script_analysis.R` (Section `0. LIBRARIES AND CONSTANTS`).

---

### script_analysis.R

Le script `script_analysis.R` est le script principal permettant de gÃ©nÃ©rer toutes les donnÃ©es de sortie (caractÃ©risation des comportements, calcul du taux de chargement, etc.) Ã  partir des donnÃ©es GPS.

Ce script sâ€™articule en cinq parties dÃ©crites ci-dessous.

---

**Partie 1 : SIMPLIFICATION DATA EN GPKG**

**Objectif :** 

Cette premiÃ¨re Ã©tape permet de simplifier les donnÃ©es GPS brutes et de les transformer en un fichier GPKG. L'objectif est de visualiser dans QGIS la date exacte de pose et de retrait des colliers GPS.

**DonnÃ©es dâ€™entrÃ©e :** 

- DonnÃ©es brutes GPS des colliers : `data/Colliers_9999_brutes/`

**DonnÃ©es de sortie :**

- Fichier GPKG gÃ©nÃ©rÃ© dans `outputs/GPS_simple_GPKG/`
- Nom du fichier : `Donnees_brutes_9999_Alpage_demo_simplifiees.gpkg`
- Ce fichier contiendra les donnÃ©es simplifiÃ©es par alpage

**Ã‰tapes de traitement QGIS pour identifier la date de pose et de retrait des colliers :**

1. ExÃ©cuter la section de code dans `script_analysis.R`.  
   Cela va gÃ©nÃ©rer le fichier GPKG dans `outputs/GPS_simple_GPKG/`.

2. Importer la couche GPKG dans QGIS.  
   - Ouvrir QGIS.  
   - Aller dans "Ajouter une couche" â†’ "Ajouter une couche vecteur".  
   - SÃ©lectionner le fichier `Donnees_brutes_9999_Alpage_demo_simplifiees.gpkg`.

3. CrÃ©er une colonne "Datetime" pour l'analyse temporelle.  
   - Ouvrir "Calculatrice de champ".  
   - Ajouter un nouveau champ :  
     - Nom : `Datetime`  
     - Type : `Date et heure`  
     - Expression :  
       `to_datetime(date)` 
     - Valider et appliquer.

4. Appliquer un style colorÃ© par ID de collier.  
   - Aller dans PropriÃ©tÃ©s de la couche â†’ Symbologie.  
   - Choisir "CatÃ©gorisÃ©".  
   - SÃ©lectionner le champ `ID`.  
   - Cliquer sur "Classer" pour attribuer une couleur unique Ã  chaque collier.

5. Activer le contrÃ´le temporel dynamique.  
   - Aller dans PropriÃ©tÃ©s de la couche â†’ Onglet "Temporel".  
   - Cocher la case "Activer le contrÃ´le temporel dynamique".  
   - Dans "Configuration", choisir :  
     - "Champ unique avec date et heure".  
     - SÃ©lectionner le champ `Datetime`.  
   - Valider.

6. Utiliser l'animation temporelle pour visualiser les trajectoires GPS.  
   - Dans la fenÃªtre principale, cliquer sur lâ€™icÃ´ne dâ€™horloge pour ouvrir le Panneau de contrÃ´le temporel.  
   - RÃ©gler la "Plage dâ€™animation" avec :  
     - Date de dÃ©but et date de fin correspondant Ã  la saison dâ€™Ã©tude.  
     - Pas de temps : 24 heures.

7. Explorer les trajectoires GPS pour identifier les dates de pose et de retrait des colliers.  
   - Jouer lâ€™animation pour voir quand chaque collier a cessÃ© dâ€™Ã©mettre.  
   - Cocher/dÃ©cocher les colliers dans la lÃ©gende pour isoler leur mouvement.

---

**Partie 2 : BJÃ˜RNERAAS FILTER CALIBRATION**

**Objectif :**

Cette partie permet dâ€™analyser et filtrer les donnÃ©es GPS en utilisant la mÃ©thode de BjÃ¸rneraas, pour Ã©liminer les erreurs de position et amÃ©liorer la qualitÃ© des trajectoires. Il offre une visualisation des donnÃ©es brutes et filtrÃ©es et permet de tester plusieurs ensembles de paramÃ¨tres avant dâ€™adopter un filtrage optimal.

**Principe du filtre de BjÃ¸rneraas :**

BjÃ¸rneraas et al. (2010) ont dÃ©veloppÃ© une mÃ©thode de filtrage des erreurs GPS en Ã©cologie du mouvement, basÃ©e sur :

- Un filtre mÃ©dian (`medcrit`) : dÃ©tecte les points aberrants sur la base des distances mÃ©dianes entre points.
- Un filtre de moyenne (`meancrit`) : supprime les points trÃ¨s Ã©loignÃ©s de la moyenne des distances parcourues.
- Un seuil de vitesse (`spikesp`) : Ã©limine les points oÃ¹ la vitesse dÃ©passe un seuil dÃ©fini.
- Un critÃ¨re de changement brutal de direction (`spikecos`) : supprime les virages anormaux.

Ces filtres permettent dâ€™Ã©liminer les erreurs dues Ã  des sauts GPS ou des rÃ©flexions du signal.

**DonnÃ©es dâ€™entrÃ©e :** 

- DonnÃ©es brutes GPS des colliers : `data/Colliers_9999_brutes/`
- Fichier dâ€™information sur lâ€™alpage : `data/Colliers_9999_brutes/9999_infos_alpages.csv`

**DonnÃ©es de sortie :** 

- Fichier PDF de sortie : `outputs/Filtre_de_Bjorneraas/Filtering_calibration_YEAR_Alpage_demo.pdf`
  - Ce fichier contiendra des visualisations des trajectoires GPS brutes, des rÃ©sultats des filtres appliquÃ©s et des erreurs dÃ©tectÃ©es (R1 et R2).
  - Chaque graphique montre les trajectoires avec des codes de couleurs pour les points valides et les erreurs dÃ©tectÃ©es.

---

**Partie 3 : FILTERING CATLOG DATA**

**Objectif :**
Cette partie permet de filtrer les donnÃ©es brutes des GPS en appliquant le filtre de BjÃ¸rneraas.

**DonnÃ©es dâ€™entrÃ©e :** 

- DonnÃ©es brutes GPS des colliers : `data/Colliers_9999_brutes/`
- Fichier dâ€™information individuel sur les colliers : `data/Colliers_9999_brutes/9999_colliers_poses.csv`

**DonnÃ©es de sortie :** 

- DonnÃ©es GPS filtrÃ©es : `outputs/Filtre_de_Bjorneraas/Catlog_9999_filtered_Alpage_demo.rds`
- Fichier CSV : `outputs/Filtre_de_Bjorneraas/9999_filtering_Alpage_demo.csv`
  - Ce fichier contiendra le nombre de points filtrÃ©s par collier en raison des erreurs dÃ©tectÃ©es (R1 et R2).
  - Ainsi que le nombre total de points filtrÃ©s tous colliers confondus.

---

**Partie 4 : HMM FITTING**

**Objectif :**
Cette partie permet l'analyse des trajectoires GPS des brebis en utilisant le modÃ¨le cachÃ© de Markov (*HMM - Hidden Markov Model*) afin de caractÃ©riser trois types de comportements : dÃ©placement, pÃ¢turage, repos.
Il s'appuie sur les trajectoires filtrÃ©es par le filtre de BjÃ¸rneraas effectuÃ© dans la partie 3.

**DonnÃ©es dâ€™entrÃ©e :** 

- DonnÃ©es GPS filtrÃ©es : `outputs/Filtre_de_Bjorneraas/Catlog_9999_filtered_Alpage_demo.rds`
- Fichier dâ€™information individuel sur les colliers : `data/Colliers_9999_brutes/9999_colliers_poses.csv`

**DonnÃ©es de sortie :** 

- Trajectoires GPS catÃ©gorisÃ©es : `outputs/HMM_comportement/Catlog_9999_Alpage_demo_viterbi.rds`
- Rapport PDF : `outputs/HMM_comportement/individual_trajectories/C00.pdf`
  - Un PDF est gÃ©nÃ©rÃ© par collier.
  - Il contient les rÃ©sultats individuels des ajustements du modÃ¨le de Markov cachÃ©.

---


**Partie 5 : FLOCK STOCKING RATE**

**Objectif :**  
Ce script permet de calculer le taux de chargement du troupeau en fonction du jour et du comportement (repos, dÃ©placement, pÃ¢turage).  
Il utilise les trajectoires GPS classifiÃ©es avec le modÃ¨le HMM ainsi que les tailles de troupeaux pour estimer la pression de pÃ¢turage** sur les alpages Ã©tudiÃ©s.

**DonnÃ©es dâ€™entrÃ©e :**  

- Trajectoires GPS catÃ©gorisÃ©es :  
  `outputs/HMM_comportement/Catlog_9999_Alpage_demo_viterbi.rds`
- Fichier dâ€™information individuel sur les colliers :  
  `data/Colliers_9999_brutes/9999_colliers_poses.csv`
- Fichier dâ€™Ã©volution de la taille du troupeau :  
  `data/Colliers_9999_brutes/9999_tailles_troupeaux.csv`

**DonnÃ©es de sortie :**  

Les rÃ©sultats sont enregistrÃ©s dans `outputs/Chargements_calcules/` et stockÃ©s dans des fichiers `.rds` par alpage.

- Taux de chargement par jour et par comportement :  
  `outputs/Chargements_calcules/Alpage_demo_9999/by_day_and_state_9999_Alpage_demo.rds`
  - Charge journaliÃ¨re par Ã©tat comportemental (`repos`, `dÃ©placement`, `pÃ¢turage`).

- Taux de chargement par Ã©tat (sur lâ€™ensemble de la saison) :  
  `outputs/Chargements_calcules/Alpage_demo_9999/by_state_9999_Alpage_demo.rds`
  - Somme des charges par Ã©tat comportemental, toutes journÃ©es confondues.

- Taux de chargement par jour :  
  `outputs/Chargements_calcules/Alpage_demo_9999/by_day_9999_Alpage_demo.rds`
  - Charge totale par jour, sans distinction de comportement.

- Taux de chargement total (saison complÃ¨te) :  
  `outputs/Chargements_calcules/Alpage_demo_9999/total_9999_Alpage_demo.rds`
  - Somme des charges sur toute la saison pour lâ€™alpage Ã©tudiÃ©.

---




## ProblÃ¨mes et erreurs possibles  

Cette section vise Ã  identifier les principaux problÃ¨mes que l'utilisateur peut rencontrer lors de l'utilisation de ce projet :  

- Format des fichiers dâ€™entrÃ©e :  
Veiller Ã  ce que les fichiers soient bien au format CSV UTF-8 avec "," comme sÃ©parateur.  

- Format des dates : Il est important de respecter le format `dd/mm/yyyy hh:mm:ss` pour les dates de pose et de retrait des colliers.  Les secondes sont essentielles pour garantir le bon fonctionnement des scripts et lâ€™interprÃ©tation correcte des donnÃ©es par les fonctions.  

- Connexion Internet stable : 
Une connexion fiable est nÃ©cessaire, notamment pour la **Partie 4** (*HMM FITTING*), qui requiert le tÃ©lÃ©chargement de donnÃ©es open data.  

- Gestion des cÅ“urs lors de la parallÃ©lisation :  
  - Par dÃ©faut, le nombre de cÅ“urs utilisÃ©s est dÃ©fini comme `nombre de cÅ“urs / 3` dans le fichier `config.R`.  
  - Il peut Ãªtre ajustÃ© en fonction des capacitÃ©s de lâ€™ordinateur.  
  - Certaines Ã©tapes nÃ©cessitent un temps de calcul long :  
    - Augmenter le nombre de cÅ“urs amÃ©liore la vitesse d'exÃ©cution.  
    - Toutefois, cela augmente l'utilisation de la RAM, ce qui peut provoquer un arrÃªt du script si la mÃ©moire est saturÃ©e.  

- Taille des jeux de donnÃ©es et nombre de colliers traitÃ©s simultanÃ©ment  
  - Plus le nombre de colliers analysÃ©s est Ã©levÃ©, plus les calculs sont longs.  
  - Exemple : Le calcul du taux de chargement prend environ 12 heures pour 40 colliers.  
  - Important d'anticiper :)
